<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test E2E - Reserva Completa Automatizada</title>
    <link rel="stylesheet" href="calendar.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            color: #0f0;
            font-family: monospace;
            padding: 20px;
            overflow-y: auto;
            z-index: 10000;
            border-left: 3px solid #0f0;
        }
        .test-header {
            background: #1a1a1a;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-bottom: 2px solid #0f0;
        }
        .test-header h2 {
            margin: 0;
            color: #0f0;
            font-size: 1.2rem;
        }
        .test-log {
            font-size: 12px;
            line-height: 1.6;
        }
        .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }
        .log-success { color: #0f0; }
        .log-error { color: #f00; }
        .log-warning { color: #ff0; }
        .log-info { color: #0ff; }
        .test-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .test-btn {
            background: #0f0;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #0d0;
        }
        .test-btn.stop {
            background: #f00;
            color: #fff;
        }
        .test-stats {
            background: #1a1a1a;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Panel de Testing -->
    <div class="test-overlay" id="testPanel">
        <div class="test-header">
            <h2>üß™ Test E2E - Reserva Completa</h2>
            <p style="margin: 5px 0 0 0; font-size: 11px; color: #888;">Automatizado - SexyFly v3.0</p>
        </div>

        <div class="test-stats" id="testStats">
            <div class="stat-item">
                <span>Estado:</span>
                <span id="testStatus" class="log-warning">Esperando...</span>
            </div>
            <div class="stat-item">
                <span>Progreso:</span>
                <span id="testProgress">0/10</span>
            </div>
            <div class="stat-item">
                <span>Tiempo:</span>
                <span id="testTime">0s</span>
            </div>
        </div>

        <div class="test-log" id="testLog">
            <div class="log-line log-info">Presiona "‚ñ∂Ô∏è EJECUTAR TEST" para comenzar</div>
        </div>
    </div>

    <div class="test-controls">
        <button class="test-btn" onclick="ejecutarTestCompleto()">‚ñ∂Ô∏è EJECUTAR TEST</button>
        <button class="test-btn stop" onclick="limpiarLog()">üóëÔ∏è LIMPIAR</button>
    </div>

    <!-- Aplicaci√≥n real -->
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Reserva de Piloto Comercial</h1>
            <p>Test E2E Automatizado</p>
        </div>

        <div class="booking-card">
            <div class="pricing-info">
                <h2>üí∞ Tarifas de Reserva</h2>
                <div class="pricing-grid">
                    <div class="price-item">
                        <h3>Reserva Anticipada</h3>
                        <div class="price">500‚Ç¨</div>
                    </div>
                    <div class="price-item">
                        <h3>Reserva Urgente</h3>
                        <div class="price">1,000‚Ç¨</div>
                    </div>
                </div>
            </div>

            <form id="bookingForm" novalidate>
                <div class="calendar-section">
                    <div id="flightCalendar"></div>
                </div>

                <div class="flight-details-section" id="flightDetailsSection" style="display: none;">
                    <h3 style="color: #1E40AF; margin-bottom: 20px;">‚úàÔ∏è Detalles del Vuelo</h3>
                    
                    <div class="form-row">
                        <div>
                            <label for="departureTime">üõ´ Hora de Salida *</label>
                            <input type="time" id="departureTime" name="departureTime">
                        </div>
                        <div>
                            <label for="returnTime">üõ¨ Hora de Regreso *</label>
                            <input type="time" id="returnTime" name="returnTime">
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="originICAO">üõ´ Origen (OACI) *</label>
                            <input type="text" id="originICAO" name="originICAO" maxlength="4" class="icao-input">
                        </div>
                        <div>
                            <label for="destinationICAO">üõ¨ Destino (OACI) *</label>
                            <input type="text" id="destinationICAO" name="destinationICAO" maxlength="4" class="icao-input">
                        </div>
                    </div>
                </div>

                <div class="form-group" id="overnightSection" style="display: none;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="overnight" name="overnight">
                        <label for="overnight">Pernocta requerida</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="clientName">üë§ Nombre</label>
                    <input type="text" id="clientName" name="clientName" required>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label for="clientEmail">üìß Email</label>
                            <input type="email" id="clientEmail" name="clientEmail" required>
                        </div>
                        <div>
                            <label for="clientPhone">üì± Tel√©fono</label>
                            <input type="tel" id="clientPhone" name="clientPhone" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="additionalInfo">üìù Info Adicional</label>
                    <textarea id="additionalInfo" name="additionalInfo" rows="4"></textarea>
                </div>

                <div class="total-flights" id="totalFlights" style="display: none;">
                    <h3 id="totalFlightsPrice"></h3>
                    <div class="breakdown" id="totalBreakdown"></div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="acceptTerms" name="acceptTerms" required>
                        <label for="acceptTerms">‚úÖ Acepto t√©rminos</label>
                    </div>
                </div>

                <div class="loading" id="loadingDiv">
                    <div class="spinner"></div>
                    <p>Procesando...</p>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">
                    üöÅ Reservar Piloto
                </button>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js?v=3.0.0"></script>
    <script src="pricing.js?v=3.0.0"></script>
    <script src="calendar.js?v=3.0.0"></script>
    <script src="app.js?v=3.0.0"></script>

    <script>
        const logDiv = document.getElementById('testLog');
        const statusDiv = document.getElementById('testStatus');
        const progressDiv = document.getElementById('testProgress');
        const timeDiv = document.getElementById('testTime');
        
        let testStartTime = 0;
        let currentStep = 0;
        const totalSteps = 10;

        function log(msg, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = msg;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        function updateStatus(status, type = 'info') {
            statusDiv.textContent = status;
            statusDiv.className = `log-${type}`;
        }

        function updateProgress(step) {
            currentStep = step;
            progressDiv.textContent = `${step}/${totalSteps}`;
        }

        function updateTime() {
            const elapsed = ((Date.now() - testStartTime) / 1000).toFixed(1);
            timeDiv.textContent = elapsed + 's';
        }

        function limpiarLog() {
            logDiv.innerHTML = '<div class="log-line log-info">Log limpiado. Listo para nuevo test.</div>';
            updateStatus('Esperando...', 'warning');
            updateProgress(0);
            timeDiv.textContent = '0s';
        }

        async function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function ejecutarTestCompleto() {
            limpiarLog();
            testStartTime = Date.now();
            const updateInterval = setInterval(updateTime, 100);

            log('‚ïê'.repeat(50), 'info');
            log('üß™ INICIANDO TEST E2E - RESERVA COMPLETA', 'info');
            log('‚ïê'.repeat(50), 'info');
            log('', 'info');
            
            updateStatus('Ejecutando...', 'warning');

            try {
                // PASO 1: Verificar app cargada
                updateProgress(1);
                log('1Ô∏è‚É£ Verificando SexyFlyApp...', 'info');
                await wait(300);
                
                if (!window.sexyFlyApp) {
                    throw new Error('SexyFlyApp no est√° disponible');
                }
                log('   ‚úÖ SexyFlyApp disponible', 'success');
                log('   ‚úÖ Calendario: ' + (window.sexyFlyApp.calendar ? 'OK' : 'FALTA'), 'success');
                log('   ‚úÖ Pricing: ' + (window.sexyFlyApp.pricing ? 'OK' : 'FALTA'), 'success');

                // PASO 2: Calcular fechas
                updateProgress(2);
                log('', 'info');
                log('2Ô∏è‚É£ Calculando fechas...', 'info');
                
                const today = new Date();
                const fechaIda = new Date(today);
                fechaIda.setDate(fechaIda.getDate() + 5); // Today + 5
                
                const diasExtra = Math.floor(Math.random() * 5) + 1; // Random 1-5
                const fechaVuelta = new Date(fechaIda);
                fechaVuelta.setDate(fechaVuelta.getDate() + diasExtra);
                
                log(`   üìÖ IDA: ${fechaIda.toLocaleDateString('es-ES')} (Today+5)`, 'success');
                log(`   üìÖ VUELTA: ${fechaVuelta.toLocaleDateString('es-ES')} (+${diasExtra} d√≠as)`, 'success');

                // PASO 3: Seleccionar fechas en calendario
                updateProgress(3);
                log('', 'info');
                log('3Ô∏è‚É£ Seleccionando fechas en calendario...', 'info');
                await wait(500);
                
                window.sexyFlyApp.calendar.setDates(fechaIda, fechaVuelta);
                
                // Trigger manual del callback
                window.sexyFlyApp.handleDateSelection({
                    departure: fechaIda,
                    return: fechaVuelta
                });
                
                await wait(500);
                
                const selectedDates = window.sexyFlyApp.getSelectedDates();
                if (!selectedDates || !selectedDates.departure || !selectedDates.return) {
                    throw new Error('Fechas no se seleccionaron correctamente');
                }
                log('   ‚úÖ Fechas seleccionadas correctamente', 'success');

                // PASO 4: Rellenar horarios
                updateProgress(4);
                log('', 'info');
                log('4Ô∏è‚É£ Rellenando horarios...', 'info');
                await wait(300);
                
                document.getElementById('departureTime').value = '10:00';
                document.getElementById('returnTime').value = '18:00';
                log('   ‚úÖ Salida: 10:00', 'success');
                log('   ‚úÖ Regreso: 18:00', 'success');

                // PASO 5: C√≥digos ICAO
                updateProgress(5);
                log('', 'info');
                log('5Ô∏è‚É£ Ingresando c√≥digos ICAO...', 'info');
                await wait(300);
                
                const originInput = document.getElementById('originICAO');
                const destInput = document.getElementById('destinationICAO');
                
                originInput.value = 'LELL';
                originInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                destInput.value = 'LEBL';
                destInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                log('   ‚úÖ Origen: LELL (Lleida)', 'success');
                log('   ‚úÖ Destino: LEBL (Barcelona)', 'success');

                // PASO 6: Datos del cliente
                updateProgress(6);
                log('', 'info');
                log('6Ô∏è‚É£ Ingresando datos del cliente...', 'info');
                await wait(300);
                
                document.getElementById('clientName').value = 'Ivan Tintore TEST';
                document.getElementById('clientEmail').value = 'ivantintore@gmail.com';
                document.getElementById('clientPhone').value = '+34656431447';
                
                log('   ‚úÖ Nombre: Ivan Tintore TEST', 'success');
                log('   ‚úÖ Email: ivantintore@gmail.com', 'success');
                log('   ‚úÖ Tel√©fono: +34656431447', 'success');

                // PASO 7: Informaci√≥n adicional
                updateProgress(7);
                log('', 'info');
                log('7Ô∏è‚É£ A√±adiendo informaci√≥n adicional...', 'info');
                await wait(300);
                
                document.getElementById('additionalInfo').value = 
                    'ESTO ES UN UNIT TESTING TEST PARA CONFIRMAR QUE FUNCIONA EL SISTEMA';
                log('   ‚úÖ Info adicional: UNIT TESTING TEST...', 'success');

                // PASO 8: Verificar precio calculado
                updateProgress(8);
                log('', 'info');
                log('8Ô∏è‚É£ Verificando c√°lculo de precio...', 'info');
                await wait(300);
                
                const totalPrice = window.sexyFlyApp.getTotalPrice();
                if (!totalPrice || totalPrice === 0) {
                    throw new Error('Precio no calculado');
                }
                log(`   ‚úÖ Precio total calculado: ${totalPrice}‚Ç¨`, 'success');

                // PASO 9: Aceptar t√©rminos
                updateProgress(9);
                log('', 'info');
                log('9Ô∏è‚É£ Aceptando t√©rminos y condiciones...', 'info');
                await wait(300);
                
                document.getElementById('acceptTerms').checked = true;
                log('   ‚úÖ T√©rminos aceptados', 'success');

                // PASO 10: Enviar formulario
                updateProgress(10);
                log('', 'info');
                log('üîü Enviando formulario...', 'info');
                updateStatus('Enviando...', 'warning');
                await wait(500);
                
                // Interceptar alert para capturar resultado
                const originalAlert = window.alert;
                let alertMessage = '';
                window.alert = function(msg) {
                    alertMessage = msg;
                    log(`   üìß Alert capturado: ${msg.substring(0, 100)}...`, 'info');
                };
                
                // Enviar formulario
                window.sexyFlyApp.handleFormSubmit();
                
                await wait(2500); // Esperar procesamiento
                
                // Restaurar alert
                window.alert = originalAlert;

                // RESULTADO FINAL
                log('', 'info');
                log('‚ïê'.repeat(50), 'success');
                log('üéâ TEST COMPLETADO EXITOSAMENTE', 'success');
                log('‚ïê'.repeat(50), 'success');
                log('', 'info');
                
                log('üìä RESUMEN DE LA RESERVA:', 'info');
                log(`   Ruta: LELL ‚Üí LEBL`, 'success');
                log(`   Fecha IDA: ${fechaIda.toLocaleDateString('es-ES')}`, 'success');
                log(`   Fecha VUELTA: ${fechaVuelta.toLocaleDateString('es-ES')}`, 'success');
                log(`   Precio Total: ${totalPrice}‚Ç¨`, 'success');
                log(`   Cliente: ivantintore@gmail.com`, 'success');
                log('', 'info');
                log('‚úÖ Formulario enviado correctamente', 'success');
                log('‚úÖ Todos los pasos completados', 'success');
                log('‚úÖ Sistema 100% funcional', 'success');
                
                updateStatus('‚úÖ √âXITO', 'success');
                clearInterval(updateInterval);

            } catch (error) {
                log('', 'info');
                log('‚ïê'.repeat(50), 'error');
                log('‚ùå TEST FALLIDO', 'error');
                log('‚ïê'.repeat(50), 'error');
                log(`Error: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
                updateStatus('‚ùå FALLIDO', 'error');
                clearInterval(updateInterval);
            }
        }

        // Auto-ejecutar al cargar (opcional)
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('‚úÖ P√°gina cargada. Lista para test.', 'success');
                log('üí° Presiona "‚ñ∂Ô∏è EJECUTAR TEST" para comenzar', 'info');
                log('', 'info');
                
                // Auto-ejecutar despu√©s de 2 segundos
                setTimeout(() => {
                    log('‚ö° Auto-ejecuci√≥n en 3 segundos...', 'warning');
                    setTimeout(() => {
                        log('üöÄ Ejecutando test autom√°ticamente...', 'warning');
                        log('', 'info');
                        ejecutarTestCompleto();
                    }, 3000);
                }, 1000);
            }, 1000);
        });
    </script>
</body>
</html>

